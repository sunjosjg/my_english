<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë°ì¼ë¦¬ í…ŒìŠ¤íŠ¸ â€” ì°¬í¬ ì˜ì–´ ë‹¨ì–´ì¥</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
    :root {
      --primary: #5b4fcf; --primary-light: #7c71e0; --primary-bg: #eef2ff;
      --green: #10b981; --green-bg: #ecfdf5; --red: #ef4444; --red-bg: #fef2f2;
      --yellow: #f59e0b; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
      --muted: #64748b; --border: #e2e8f0; --radius: 14px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .hb-btn { position: fixed; top: 14px; left: 14px; z-index: 300; background: var(--card); border: 2px solid var(--border); border-radius: 12px; width: 46px; height: 46px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .hb-btn span { display: block; width: 20px; height: 2.5px; background: var(--text); border-radius: 2px; }
    .hb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 400; display: none; }
    .hb-overlay.open { display: block; }
    .hb-drawer { position: absolute; left: 0; top: 0; bottom: 0; width: 290px; background: var(--card); padding: 24px 20px 32px; transform: translateX(-100%); transition: transform 0.25s cubic-bezier(0.4,0,0.2,1); overflow-y: auto; }
    .hb-overlay.open .hb-drawer { transform: translateX(0); }
    .hb-hd { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .hb-title { font-size: 18px; font-weight: 800; color: var(--primary); }
    .hb-close { background: none; border: none; font-size: 26px; cursor: pointer; color: var(--muted); }
    .hb-unit { background: var(--primary-bg); border-radius: 10px; padding: 10px 14px; margin-bottom: 14px; font-size: 13px; color: var(--primary); font-weight: 600; line-height: 1.6; }
    .hb-mode-btn { width: 100%; padding: 13px 16px; text-align: left; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; transition: all 0.15s; }
    .hb-mode-btn:hover { border-color: var(--primary); background: var(--primary-bg); }
    .hb-mode-btn.current { border-color: var(--primary); background: var(--primary-bg); color: var(--primary); }
    .page { padding: 16px; max-width: 760px; margin: 0 auto; padding-bottom: 48px; }
    .screen { display: none; }
    .screen.active { display: block; }

    /* â”€â”€ STEP HEADER â”€â”€ */
    .step-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .step-back { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 4px 8px; border-radius: 8px; }
    .step-back:hover { background: var(--border); }
    .step-title { flex: 1; }
    .step-label { font-size: 20px; font-weight: 800; color: var(--primary); }
    .step-desc  { font-size: 13px; color: var(--muted); margin-top: 2px; }
    .step-badge { background: var(--primary); color: #fff; font-size: 13px; font-weight: 700; padding: 5px 14px; border-radius: 20px; white-space: nowrap; }

    /* â”€â”€ STEP 1 & 2: WORD ROWS â”€â”€ */
    .word-list { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
    .word-row { display: grid; grid-template-columns: 28px 1fr 1fr; gap: 10px; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .word-row:last-child { border-bottom: none; }
    .wr-no     { font-size: 12px; color: var(--muted); text-align: center; }
    .wr-prompt { font-size: 16px; font-weight: 700; }
    .wr-sub    { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .wr-input  { width: 100%; padding: 10px 12px; font-size: 17px; border: 2px solid var(--border); border-radius: 8px; outline: none; font-family: inherit; transition: border-color 0.2s; }
    .wr-input:focus { border-color: var(--primary); }

    /* â”€â”€ STEP 3: SENTENCE CARDS â”€â”€ */
    .step3-layout { display: grid; grid-template-columns: 1fr 130px; gap: 14px; align-items: start; }
    .step3-wordbank { position: sticky; top: 16px; background: var(--card); border-radius: var(--radius); border: 2px solid var(--primary); padding: 12px 10px; }
    .wb-title { font-size: 11px; font-weight: 800; color: var(--primary); margin-bottom: 10px; text-align: center; letter-spacing: 0.05em; }
    .wb-item { padding: 8px 10px; font-size: 14px; font-weight: 700; border-radius: 8px; margin-bottom: 6px; background: var(--primary-bg); color: var(--primary); text-align: center; transition: all 0.2s; }
    .wb-item.used { background: var(--border); color: var(--muted); text-decoration: line-through; opacity: 0.5; }

    .sentence-card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); padding: 18px 20px; margin-bottom: 12px; }
    .sc-no       { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .sc-sentence { font-size: 19px; line-height: 1.75; color: var(--text); margin-bottom: 12px; }
    .sc-blank    { color: var(--primary); border-bottom: 2px solid var(--primary); padding: 0 6px; font-weight: 700; }
    .sc-hint     { font-size: 13px; color: var(--muted); margin-bottom: 10px; }
    .sc-input    { width: 100%; padding: 13px 15px; font-size: 18px; border: 2px solid var(--border); border-radius: 8px; outline: none; font-family: inherit; transition: border-color 0.2s; }
    .sc-input:focus { border-color: var(--primary); }

    /* â”€â”€ COMPLETE BUTTON â”€â”€ */
    .complete-btn { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius); font-size: 17px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .complete-btn:hover { background: var(--primary-light); }

    /* â”€â”€ FINAL: HEADER â”€â”€ */
    .final-header { text-align: center; background: linear-gradient(135deg, #5b4fcf, #7c71e0); color: #fff; border-radius: var(--radius); padding: 24px 20px; margin-bottom: 20px; }
    .fh-title { font-size: 24px; font-weight: 900; margin-bottom: 6px; }
    .fh-sub   { font-size: 15px; opacity: 0.9; line-height: 1.5; }

    /* â”€â”€ FINAL: RESULT LISTING â”€â”€ */
    .result-section { margin-bottom: 16px; }
    .rs-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .rs-item  { display: flex; gap: 10px; align-items: flex-start; padding: 10px 14px; border-left: 3px solid var(--red); background: var(--red-bg); margin-bottom: 6px; border-radius: 0 10px 10px 0; }
    .rs-word  { font-weight: 700; color: var(--red); min-width: 100px; font-size: 15px; }
    .rs-detail { font-size: 13px; color: var(--muted); line-height: 1.6; }
    .rs-correct { color: var(--green); font-weight: 600; }
    .rs-no-wrong { font-size: 14px; color: var(--green); font-weight: 600; padding: 8px 0; }

    /* â”€â”€ FINAL: WRITING SECTION â”€â”€ */
    .write-header { margin: 28px 0 16px; }
    .wh-title { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
    .wh-sub   { font-size: 13px; color: var(--muted); }

    .write-card { background: var(--card); border-radius: var(--radius); border: 2px solid var(--border); padding: 20px 20px 16px; margin-bottom: 16px; }
    .wc-word   { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 6px; }
    .wc-ref    { font-size: 16px; color: var(--text); line-height: 1.6; background: var(--primary-bg); border-radius: 8px; padding: 10px 14px; margin-bottom: 14px; font-weight: 600; }
    .wc-lines  { display: flex; flex-direction: column; gap: 8px; }
    .wc-line   { display: flex; align-items: center; gap: 8px; }
    .wc-num    { font-size: 14px; color: var(--muted); font-weight: 700; min-width: 22px; text-align: right; }
    .wc-sep    { font-size: 18px; color: var(--border); flex-shrink: 0; }
    .wc-sentence { font-size: 17px !important; }
    .wc-input  {
      flex: 1; padding: 14px 4px; font-size: 22px; font-weight: 600; letter-spacing: 1px;
      border: none; border-bottom: 2.5px solid #cbd5e1; outline: none;
      font-family: inherit; background: transparent; transition: border-color 0.2s;
      min-height: 58px; border-radius: 0;
    }
    .wc-input:focus { border-bottom-color: var(--primary); }
    .wc-input.ok   { border-bottom-color: var(--green); color: #065f46; }
    .wc-input.fail { border-bottom-color: var(--red); color: var(--red); background: #fff0f0; border-radius: 6px; padding: 14px 10px; }

    /* â”€â”€ MOM CHECK â”€â”€ */
    .mom-section { margin-top: 28px; text-align: center; padding: 24px 20px; background: #fff8e1; border-radius: var(--radius); border: 2px dashed #f59e0b; }
    .mom-msg  { font-size: 17px; font-weight: 700; color: #92400e; margin-bottom: 14px; line-height: 1.5; }
    .mom-summary { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; text-align: left; }
    .ms-row  { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; border-radius: 8px; font-size: 15px; font-weight: 600; }
    .ms-ok   { background: #ecfdf5; color: #065f46; }
    .ms-bad  { background: #fef2f2; color: #b91c1c; }
    .ms-step { font-weight: 800; }
    .mom-btn  { padding: 16px 36px; background: #f59e0b; color: #fff; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 800; cursor: pointer; transition: background 0.2s; }
    .mom-btn:hover { background: #d97706; }
    .mom-result { margin-top: 14px; font-size: 15px; font-weight: 600; display: none; line-height: 1.5; }
    .mom-result.ok   { color: #065f46; }
    .mom-result.fail { color: var(--red); }

    .done-btn { display: none; width: 100%; padding: 16px; margin-top: 16px; background: var(--green); color: #fff; border: none; border-radius: var(--radius); font-size: 17px; font-weight: 700; cursor: pointer; }

    /* â”€â”€ ALL CORRECT â”€â”€ */
    .all-correct { text-align: center; padding: 28px 20px; background: var(--green-bg); border-radius: var(--radius); border: 2px solid var(--green); margin-top: 12px; }
    .ac-emoji { font-size: 56px; margin-bottom: 10px; }
    .ac-title { font-size: 26px; font-weight: 900; color: var(--green); margin-bottom: 6px; }
    .ac-sub   { font-size: 15px; color: #065f46; }

    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
<button class="hb-btn" onclick="hbOpen()"><span></span><span></span><span></span></button>
<div class="hb-overlay" id="hb-overlay" onclick="if(event.target===this)hbClose()">
  <div class="hb-drawer">
    <div class="hb-hd"><div class="hb-title">ğŸ“š í•™ìŠµ ë©”ë‰´</div><button class="hb-close" onclick="hbClose()">âœ•</button></div>
    <div class="hb-unit" id="hb-unit"></div>
    <button class="hb-mode-btn" onclick="hbGo('home')">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
    <button class="hb-mode-btn" onclick="hbGo('study')">ğŸƒ í”Œë˜ì‹œì¹´ë“œ</button>
    <button class="hb-mode-btn" onclick="hbGo('sentence')">ğŸ§© ë¬¸ì¥ ì™„ì„±</button>
    <button class="hb-mode-btn current" onclick="hbClose()">ğŸ“ Daily Test (í˜„ì¬)</button>
  </div>
</div>

<!-- â•â• STEP 1: í•œê¸€ â†’ ì˜ì–´ â•â• -->
<div id="screen-step1" class="screen active">
  <div class="page">
    <div class="step-header">
      <button class="step-back" onclick="goHome()">â†</button>
      <div class="step-title">
        <div class="step-label">1ë‹¨ê³„ Â· í•œê¸€ â†’ ì˜ì–´</div>
        <div class="step-desc">í•œê¸€ ëœ»ì„ ë³´ê³  ì˜ì–´ ë‹¨ì–´ë¥¼ ì“°ì„¸ìš”</div>
      </div>
      <div class="step-badge">1 / 3</div>
    </div>
    <div class="word-list" id="step1-list"></div>
    <button class="complete-btn" onclick="completeStep1()">âœ… ì™„ë£Œ â€” ë‹¤ìŒ ë‹¨ê³„</button>
  </div>
</div>

<!-- â•â• STEP 2: ì˜ì–´ â†’ í•œê¸€ â•â• -->
<div id="screen-step2" class="screen">
  <div class="page">
    <div class="step-header">
      <div class="step-title">
        <div class="step-label">2ë‹¨ê³„ Â· ì˜ì–´ â†’ í•œê¸€</div>
        <div class="step-desc">ì˜ì–´ ë‹¨ì–´ë¥¼ ë³´ê³  í•œê¸€ ëœ»ì„ ì“°ì„¸ìš”</div>
      </div>
      <div class="step-badge">2 / 3</div>
    </div>
    <div class="word-list" id="step2-list"></div>
    <button class="complete-btn" onclick="completeStep2()">âœ… ì™„ë£Œ â€” ë‹¤ìŒ ë‹¨ê³„</button>
  </div>
</div>

<!-- â•â• STEP 3: ë¬¸ì¥ ë¹ˆì¹¸ â•â• -->
<div id="screen-step3" class="screen">
  <div class="page">
    <div class="step-header">
      <div class="step-title">
        <div class="step-label">3ë‹¨ê³„ Â· ë¬¸ì¥ ë¹ˆì¹¸ ì±„ìš°ê¸°</div>
        <div class="step-desc">ë¬¸ì¥ì„ ì½ê³  ë¹ˆì¹¸ì— ì•Œë§ì€ ë‹¨ì–´ë¥¼ ì“°ì„¸ìš”</div>
      </div>
      <div class="step-badge">3 / 3</div>
    </div>
    <div class="step3-layout">
      <div id="step3-list"></div>
      <div class="step3-wordbank">
        <div class="wb-title">ë‹¨ì–´ ëª©ë¡</div>
        <div id="wordbank-list"></div>
      </div>
    </div>
    <button class="complete-btn" onclick="completeStep3()">âœ… ì™„ë£Œ â€” ê²°ê³¼ ë³´ê¸°</button>
  </div>
</div>

<!-- â•â• FINAL SCREEN â•â• -->
<div id="screen-final" class="screen">
  <div class="page">
    <div class="final-header">
      <div class="fh-title">ğŸ“‹ ë°ì¼ë¦¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
      <div class="fh-sub" id="final-sub"></div>
    </div>
    <div id="final-results"></div>
    <div id="final-write"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const params   = new URLSearchParams(location.search);
const courseId = params.get('c');
const typeId   = params.get('t');
const unitId   = params.get('u');

let words      = [];
let step1Wrong = [];   // { word, user }
let step2Wrong = [];
let step3Wrong = [];
let step2Order = [];
let step3Order = [];

// â”€â”€ STAR (localStorage) â”€â”€
function starKey() { return `star_${courseId}_${typeId}_${unitId}`; }
function saveStarWords(englishArr) {
  if (!englishArr.length) return;
  try {
    const existing = JSON.parse(localStorage.getItem(starKey()) || '[]');
    const merged = [...new Set([...existing, ...englishArr])];
    localStorage.setItem(starKey(), JSON.stringify(merged));
  } catch {}
}

// â”€â”€ LOAD â”€â”€
(async () => {
  if (!courseId || !typeId || !unitId) { location.href = 'index.html'; return; }
  try {
    const r    = await fetch(`data/${courseId}/${typeId}/${unitId}.json`);
    const data = await r.json();
    words = data.words;
    renderStep1();
    renderStep2();
    renderStep3();
  } catch { alert('âš ï¸ íŒŒì¼ ë¡œë”© ì‹¤íŒ¨'); }
})();

// â”€â”€ RENDER STEP 1 â”€â”€
function renderStep1() {
  const list = document.getElementById('step1-list');
  words.forEach((w, i) => {
    const row = document.createElement('div');
    row.className = 'word-row';
    row.innerHTML = `
      <span class="wr-no">${i + 1}</span>
      <div>
        <div class="wr-prompt">${w.korean}</div>
      </div>
      <input class="wr-input" type="text" placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">`;
    list.appendChild(row);
  });
  addEnterNav('#step1-list .wr-input');
  if (new URLSearchParams(location.search).get('fill') === '1')
    document.querySelectorAll('#step1-list .wr-input').forEach((inp, i) => { inp.value = words[i].english; });
}

// â”€â”€ RENDER STEP 2 â”€â”€
function renderStep2() {
  step2Order = shuffle([...words]);
  const list = document.getElementById('step2-list');
  step2Order.forEach((w, i) => {
    const row = document.createElement('div');
    row.className = 'word-row';
    row.innerHTML = `
      <span class="wr-no">${i + 1}</span>
      <div>
        <div class="wr-prompt">${w.english}</div>
      </div>
      <input class="wr-input" type="text" placeholder="" autocomplete="off" spellcheck="false">`;
    list.appendChild(row);
  });
  addEnterNav('#step2-list .wr-input');
  if (new URLSearchParams(location.search).get('fill') === '1')
    document.querySelectorAll('#step2-list .wr-input').forEach((inp, i) => { inp.value = step2Order[i].korean.split(',')[0]; });
}

// â”€â”€ RENDER STEP 3 â”€â”€
function renderStep3() {
  step3Order = shuffle([...words]);
  const list = document.getElementById('step3-list');

  // ì •ë‹µ ëª©ë¡ (ì„ì–´ì„œ ì˜¤ë¥¸ìª½ì— í‘œì‹œ)
  const bankEl = document.getElementById('wordbank-list');
  shuffle([...step3Order]).forEach(w => {
    const item = document.createElement('div');
    item.className = 'wb-item';
    item.dataset.answer = w.answer;
    item.textContent = w.answer;
    bankEl.appendChild(item);
  });

  step3Order.forEach((w, i) => {
    const card = document.createElement('div');
    card.className = 'sentence-card';
    const sentHtml = w.sentence.replace('___', '<span class="sc-blank">___</span>');
    card.innerHTML = `
      <div class="sc-no">${i + 1}ë²ˆ</div>
      <div class="sc-sentence">${sentHtml}</div>
      <input class="sc-input" type="text" placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">`;
    card.querySelector('.sc-input').addEventListener('input', updateWordBank);
    list.appendChild(card);
  });
  addEnterNav('#step3-list .sc-input');
  if (new URLSearchParams(location.search).get('fill') === '1')
    document.querySelectorAll('#step3-list .sc-input').forEach((inp, i) => { inp.value = step3Order[i].answer; });
}

function updateWordBank() {
  const inputs = [...document.querySelectorAll('#step3-list .sc-input')];
  // í˜„ì¬ ì…ë ¥ëœ ê°’ë“¤ ìˆ˜ì§‘ (ì‚¬ìš©ëœ answer ì¶”ì )
  const usedAnswers = [];
  inputs.forEach((inp, i) => {
    const val = normEn(inp.value);
    if (val) usedAnswers.push(val);
  });
  // ë‹¨ì–´ ëª©ë¡ì—ì„œ ì‚¬ìš©ëœ ê²ƒ í‘œì‹œ
  document.querySelectorAll('#wordbank-list .wb-item').forEach(item => {
    const ans = normEn(item.dataset.answer);
    const idx = usedAnswers.indexOf(ans);
    if (idx !== -1) {
      item.classList.add('used');
      usedAnswers.splice(idx, 1); // í•˜ë‚˜ì”©ë§Œ ì†Œë¹„ (ì¤‘ë³µ ë‹¨ì–´ ëŒ€ì‘)
    } else {
      item.classList.remove('used');
    }
  });
}


function addEnterNav(selector) {
  const all = [...document.querySelectorAll(selector)];
  all.forEach((inp, i) => {
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter' && i < all.length - 1) { e.preventDefault(); all[i + 1].focus(); }
    });
  });
}

// â”€â”€ GRADE â”€â”€
const norm    = s => (s || '').trim().toLowerCase().replace(/\s+/g, ' ');
const normEn  = s => (s || '').trim().replace(/\s+/g, ' '); // ì˜ì–´: ëŒ€ì†Œë¬¸ì êµ¬ë¶„, ì—°ì† ê³µë°±â†’1ì¹¸
// í•œê¸€ ì •ê·œí™”: ~ ì œê±°, ë„ì–´ì“°ê¸° ë¬´ì‹œ, ì½¤ë§ˆ êµ¬ë¶„ ì •ë‹µ í—ˆìš©
const normKr  = s => (s || '').replace(/~/g, '').replace(/\s+/g, '').trim();
function matchKorean(user, correct) {
  const u = normKr(user);
  return correct.split(',').map(k => normKr(k)).some(k => k === u);
}

function completeStep1() {
  const inputs = [...document.querySelectorAll('#step1-list .wr-input')];
  step1Wrong = [];
  inputs.forEach((inp, i) => {
    const w = words[i];
    const user = inp.value.trim();
    const ok = normEn(user) === normEn(w.english);
    if (!ok) {
      step1Wrong.push({ word: w, user });
      saveStarWords([w.english]);
    }
  });
  showScreen('screen-step2');
  focusFirst('#step2-list .wr-input');
}

function completeStep2() {
  const inputs = [...document.querySelectorAll('#step2-list .wr-input')];
  step2Wrong = [];
  inputs.forEach((inp, i) => {
    const w = step2Order[i];
    const user = inp.value.trim();
    const ok = matchKorean(user, w.korean);
    if (!ok) {
      step2Wrong.push({ word: w, user });
      saveStarWords([w.english]);
    }
  });
  showScreen('screen-step3');
  focusFirst('#step3-list .sc-input');
}

function completeStep3() {
  const inputs = [...document.querySelectorAll('#step3-list .sc-input')];
  step3Wrong = [];
  inputs.forEach((inp, i) => {
    const w = step3Order[i];
    const user = inp.value.trim();
    const ok = normEn(user) === normEn(w.answer);
    if (!ok) {
      step3Wrong.push({ word: w, user });
      saveStarWords([w.english]);
    }
  });
  renderFinal();
  showScreen('screen-final');
}

// â”€â”€ FINAL â”€â”€
function renderFinal() {
  const totalWrong = step1Wrong.length + step2Wrong.length + step3Wrong.length;

  // ì„œë¸Œ íƒ€ì´í‹€
  document.getElementById('final-sub').textContent = totalWrong === 0
    ? 'ğŸ‰ ì„¸ ë‹¨ê³„ ëª¨ë‘ ì™„ë²½í•˜ê²Œ ë§ì·„ì–´ìš”!'
    : `ì´ ${totalWrong}ê°œ í‹€ë ¸ì–´ìš” Â· í‹€ë¦° ë‹¨ì–´ë¥¼ 5ë²ˆì”© ì¨ë´ìš” âœï¸`;

  // ë‹¨ê³„ë³„ ì˜¤ë‹µ ë¦¬ìŠ¤íŒ…
  const resultsEl = document.getElementById('final-results');
  const sections = [
    { label: '1ë‹¨ê³„ Â· í•œê¸€â†’ì˜ì–´', wrong: step1Wrong, ansKey: w => w.english },
    { label: '2ë‹¨ê³„ Â· ì˜ì–´â†’í•œê¸€', wrong: step2Wrong, ansKey: w => w.korean },
    { label: '3ë‹¨ê³„ Â· ë¬¸ì¥ ë¹ˆì¹¸', wrong: step3Wrong, ansKey: w => w.answer },
  ];
  sections.forEach(sec => {
    const wrap = document.createElement('div');
    wrap.className = 'result-section';
    wrap.innerHTML = `<div class="rs-label">${sec.label}</div>`;
    if (!sec.wrong.length) {
      wrap.innerHTML += `<div class="rs-no-wrong">âœ… ëª¨ë‘ ì •ë‹µ!</div>`;
    } else {
      sec.wrong.forEach(({ word, user }) => {
        wrap.innerHTML += `
          <div class="rs-item">
            <div class="rs-word">${word.english}</div>
            <div class="rs-detail">
              ë‚´ ë‹µ: <span style="color:var(--red)">"${user || '(ë¯¸ì…ë ¥)'}"</span><br>
              ì •ë‹µ: <span class="rs-correct">"${sec.ansKey(word)}"</span>
            </div>
          </div>`;
      });
    }
    resultsEl.appendChild(wrap);
  });

  // ì“°ê¸° ì„¹ì…˜
  const writeEl = document.getElementById('final-write');

  if (totalWrong === 0) {
    writeEl.innerHTML = `
      <div class="all-correct">
        <div class="ac-emoji">ğŸ‘ğŸ‘</div>
        <div class="ac-title">ì™„ë²½í•´ìš”! ìŒë”°ë´‰!</div>
        <div class="ac-sub">ì„¸ ë‹¨ê³„ ëª¨ë‘ í•œ ë²ˆì— ë§ì·„ì–´ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”!</div>
      </div>
      <button class="done-btn" style="display:block;margin-top:16px;" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>`;
    return;
  }

  // 1Â·2ë‹¨ê³„ ê³ ìœ  í‹€ë¦° ë‹¨ì–´
  const seenWord = new Set();
  const uniqueWordWrong = [];
  [...step1Wrong, ...step2Wrong].forEach(({ word }) => {
    if (!seenWord.has(word.english)) { seenWord.add(word.english); uniqueWordWrong.push(word); }
  });

  // 3ë‹¨ê³„ ê³ ìœ  í‹€ë¦° ë‹¨ì–´ (ë¬¸ì¥)
  const seenSent = new Set();
  const uniqueSentWrong = [];
  step3Wrong.forEach(({ word }) => {
    if (!seenSent.has(word.english)) { seenSent.add(word.english); uniqueSentWrong.push(word); }
  });

  writeEl.innerHTML = '';

  // â”€â”€ ë‹¨ì–´ ì“°ê¸° (1Â·2ë‹¨ê³„) â”€â”€
  if (uniqueWordWrong.length > 0) {
    writeEl.insertAdjacentHTML('beforeend', `
      <div class="write-header">
        <div class="wh-title">âœï¸ í‹€ë¦° ë‹¨ì–´ 5ë²ˆì”© ì¨ë´ìš”!</div>
        <div class="wh-sub">1Â·2ë‹¨ê³„ì—ì„œ í‹€ë¦° ë‹¨ì–´ë¥¼ ì˜ì–´+í•œê¸€ë¡œ ì¨ë³´ì„¸ìš”.</div>
      </div>`);

    uniqueWordWrong.forEach(w => {
      const card = document.createElement('div');
      card.className = 'write-card';
      card.dataset.type   = 'word';
      card.dataset.word   = w.english;
      card.dataset.korean = w.korean;

      let lines = '';
      for (let n = 1; n <= 5; n++) {
        lines += `
          <div class="wc-line">
            <span class="wc-num">${n}</span>
            <input class="wc-input" type="text" data-lang="en" data-answer="${w.english}"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="wc-sep">|</span>
            <input class="wc-input" type="text" data-lang="ko" data-answer="${w.korean}"
              autocomplete="off" spellcheck="false">
          </div>`;
      }
      card.innerHTML = `
        <div class="wc-word">${w.english} <span style="font-size:16px;font-weight:400;color:var(--muted)">${w.korean}</span></div>
        <div class="wc-lines">${lines}</div>`;

      bindCardInputs(card);
      writeEl.appendChild(card);
    });
  }

  // â”€â”€ ë¬¸ì¥ ì“°ê¸° (3ë‹¨ê³„) â”€â”€
  if (uniqueSentWrong.length > 0) {
    writeEl.insertAdjacentHTML('beforeend', `
      <div class="write-header" style="margin-top:${uniqueWordWrong.length > 0 ? '28px' : '0'}">
        <div class="wh-title">âœï¸ í‹€ë¦° ë¬¸ì¥ 5ë²ˆì”© ì¨ë´ìš”!</div>
        <div class="wh-sub">3ë‹¨ê³„ì—ì„œ í‹€ë¦° ë¬¸ì¥ì„ ë³´ê³  ì¨ë³´ì„¸ìš”.</div>
      </div>`);

    uniqueSentWrong.forEach(w => {
      const card = document.createElement('div');
      card.className = 'write-card';
      card.dataset.type     = 'sentence';
      const fullSentence = w.sentence.replace('___', w.answer);
      card.dataset.sentence = fullSentence;

      let lines = '';
      for (let n = 1; n <= 5; n++) {
        lines += `
          <div class="wc-line">
            <span class="wc-num">${n}</span>
            <input class="wc-input wc-sentence" type="text" data-lang="sentence"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          </div>`;
      }
      card.innerHTML = `
        <div class="wc-word">${w.english} <span style="font-size:16px;font-weight:400;color:var(--muted)">${w.korean}</span></div>
        <div class="wc-ref">${fullSentence}</div>
        <div class="wc-lines">${lines}</div>`;

      bindCardInputs(card);
      writeEl.appendChild(card);
    });
  }

  writeEl.insertAdjacentHTML('beforeend', `
    <div class="mom-section">
      <div class="mom-msg">âœ‹ ë‹¤ ì¼ìœ¼ë©´<br>ì—„ë§ˆì—ê²Œ í™•ì¸ ë°›ìœ¼ì„¸ìš”!</div>
      <div class="mom-summary">
        <div class="ms-row ${step1Wrong.length === 0 ? 'ms-ok' : 'ms-bad'}">
          <span class="ms-step">1ë‹¨ê³„</span>
          <span class="ms-count">${step1Wrong.length === 0 ? 'âœ… ëª¨ë‘ ì •ë‹µ' : `âŒ ${step1Wrong.length}ê°œ í‹€ë¦¼`}</span>
        </div>
        <div class="ms-row ${step2Wrong.length === 0 ? 'ms-ok' : 'ms-bad'}">
          <span class="ms-step">2ë‹¨ê³„</span>
          <span class="ms-count">${step2Wrong.length === 0 ? 'âœ… ëª¨ë‘ ì •ë‹µ' : `âŒ ${step2Wrong.length}ê°œ í‹€ë¦¼`}</span>
        </div>
        <div class="ms-row ${step3Wrong.length === 0 ? 'ms-ok' : 'ms-bad'}">
          <span class="ms-step">3ë‹¨ê³„</span>
          <span class="ms-count">${step3Wrong.length === 0 ? 'âœ… ëª¨ë‘ ì •ë‹µ' : `âŒ ${step3Wrong.length}ê°œ í‹€ë¦¼`}</span>
        </div>
      </div>
      <button class="mom-btn" onclick="momCheck()">ğŸ‘© ì—„ë§ˆ í™•ì¸</button>
      <div class="mom-result" id="mom-result"></div>
    </div>
    <button class="done-btn" id="done-btn" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>`);
}

// â”€â”€ BIND CARD INPUTS (Enter ì´ë™ + ë³µë¶™ ì°¨ë‹¨) â”€â”€
function bindCardInputs(card) {
  const inputs = [...card.querySelectorAll('.wc-input')];
  inputs.forEach((inp, i) => {
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter' && i < inputs.length - 1) { e.preventDefault(); inputs[i + 1].focus(); }
    });
    ['paste', 'copy', 'cut'].forEach(ev =>
      inp.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); })
    );
  });
}

// â”€â”€ MOM CHECK â”€â”€
function momCheck() {
  const cards = document.querySelectorAll('.write-card');
  let allOk = true;
  const failWords = [];

  cards.forEach(card => {
    const type = card.dataset.type;
    const inputs = [...card.querySelectorAll('.wc-input')];
    let cardOk = true;

    if (type === 'sentence') {
      const fullSentence = card.dataset.sentence;
      inputs.forEach(inp => {
        const ok = normEn(inp.value) === normEn(fullSentence);
        inp.classList.remove('ok', 'fail');
        inp.classList.add(ok ? 'ok' : 'fail');
        if (!ok) cardOk = false;
      });
      if (!cardOk) failWords.push(card.querySelector('.wc-word').childNodes[0].textContent.trim());
    } else {
      const enWord = card.dataset.word;
      const krWord = card.dataset.korean;
      inputs.forEach(inp => {
        const lang = inp.dataset.lang;
        const ok = lang === 'ko'
          ? matchKorean(inp.value, krWord)
          : normEn(inp.value) === normEn(enWord);
        inp.classList.remove('ok', 'fail');
        inp.classList.add(ok ? 'ok' : 'fail');
        if (!ok) cardOk = false;
      });
      if (!cardOk) failWords.push(enWord);
    }
    if (!cardOk) allOk = false;
  });

  const resultEl = document.getElementById('mom-result');
  resultEl.style.display = 'block';

  if (allOk) {
    resultEl.className = 'mom-result ok';
    resultEl.textContent = 'ğŸ‰ ëª¨ë‘ ì˜ ì¼ì–´ìš”! ì •ë§ ì˜í–ˆì–´ìš”!!';
    document.getElementById('done-btn').style.display = 'block';
    document.querySelector('.mom-btn').disabled = true;
    document.querySelector('.mom-btn').style.opacity = '0.5';
  } else {
    resultEl.className = 'mom-result fail';
    resultEl.innerHTML = `âŒ ì•„ì§ í‹€ë¦° ê²Œ ìˆì–´ìš”!<br><strong>${failWords.join(', ')}</strong><br>ë¹¨ê°„ ì¹¸ì„ ë‹¤ì‹œ ì¨ë´ìš”!`;
    // ì²« ë²ˆì§¸ í‹€ë¦° ì¹¸ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    const firstFail = document.querySelector('.wc-input.fail');
    if (firstFail) firstFail.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// â”€â”€ UTILS â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

function focusFirst(selector) {
  setTimeout(() => {
    const el = document.querySelector(selector);
    if (el) el.focus();
  }, 150);
}

function goHome() { location.href = 'index.html'; }

function hbOpen() {
  document.getElementById('hb-unit').textContent = `${courseId} Â· ${typeId} Â· ${unitId}`;
  document.getElementById('hb-overlay').classList.add('open');
}
function hbClose() { document.getElementById('hb-overlay').classList.remove('open'); }
function hbGo(mode) {
  hbClose();
  const p = new URLSearchParams({ c: courseId, t: typeId, u: unitId });
  if (mode === 'home') { location.href = 'index.html'; return; }
  const map = { study: 'study.html', sentence: 'sentence.html' };
  location.href = `${map[mode]}?${p}`;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>