<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ÎπàÏπ∏ ÌÄ¥Ï¶à ‚Äî Ï∞¨Ìù¨ ÏòÅÏñ¥ Îã®Ïñ¥Ïû•</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
    :root {
      --primary: #5b4fcf; --primary-light: #7c71e0; --primary-bg: #eef2ff;
      --green: #10b981; --green-bg: #ecfdf5; --red: #ef4444; --red-bg: #fef2f2;
      --yellow: #f59e0b; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
      --muted: #64748b; --border: #e2e8f0; --radius: 14px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .page { padding: 16px; max-width: 860px; margin: 0 auto; }
    .screen { display: none; }
    .screen.active { display: block; }
    .screen-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .back-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 4px 8px; border-radius: 8px; }
    .back-btn:hover { background: var(--border); }
    .progress-wrap { flex: 1; }
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.3s; }
    .progress-text { font-size: 13px; color: var(--muted); white-space: nowrap; }

    /* QUIZ */
    .quiz-card { background: var(--card); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 16px; }
    .qc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .qc-word { font-size: 20px; font-weight: 800; color: var(--primary); }
    .qc-pos  { font-size: 12px; color: var(--muted); background: var(--border); padding: 2px 8px; border-radius: 10px; }
    .qc-korean { font-size: 15px; color: var(--muted); margin-top: 4px; }
    .qc-sentence { font-size: 19px; line-height: 1.7; margin-bottom: 20px; color: var(--text); }
    .blank { color: var(--primary); border-bottom: 2px solid var(--primary); padding: 0 4px; }
    .quiz-input { width: 100%; padding: 14px 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 10px; outline: none; transition: border-color 0.2s; font-family: inherit; }
    .quiz-input:focus { border-color: var(--primary); }
    .quiz-input.correct { border-color: var(--green); background: var(--green-bg); }
    .quiz-input.wrong   { border-color: var(--red);   background: var(--red-bg); }
    .feedback { display: none; margin-top: 10px; padding: 10px 14px; border-radius: 8px; font-size: 14px; font-weight: 500; }
    .feedback.correct { display: block; background: var(--green-bg); color: #065f46; }
    .feedback.wrong   { display: block; background: var(--red-bg);   color: #991b1b; }
    .submit-btn { width: 100%; padding: 14px; margin-top: 12px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .submit-btn:hover { background: var(--primary-light); }

    /* RESULT */
    #screen-result .page { text-align: center; }
    .score-ring { width: 160px; height: 160px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 24px auto; box-shadow: 0 8px 30px rgba(91,79,207,0.3); }
    .sr-num   { font-size: 52px; font-weight: 800; line-height: 1; }
    .sr-total { font-size: 15px; opacity: 0.8; }
    .result-title { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
    .result-sub   { font-size: 15px; color: var(--muted); }
    .section-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin: 20px 0 8px; }
    .wrong-section { text-align: left; margin-top: 24px; }
    .wrong-item { padding: 12px 14px; border-left: 3px solid var(--red); background: var(--red-bg); margin-bottom: 8px; border-radius: 0 10px 10px 0; }
    .wi-word { font-weight: 700; color: var(--red); }
    .wi-ans  { font-size: 13px; color: var(--muted); margin-top: 3px; }
    .result-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
    .result-btn { padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; border: 2px solid var(--border); background: var(--card); transition: all 0.15s; }
    .result-btn:hover { border-color: var(--primary); }
    .result-btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .done-action { margin-top: 12px; margin-bottom: 32px; }
    .result-btn.done-btn { width: 100%; background: #ecfdf5; border-color: #10b981; color: #065f46; }
    .result-btn.done-btn.on { background: #10b981; color: #fff; border-color: #10b981; }

    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
    .toast.show { opacity: 1; }

    /* ‚îÄ‚îÄ CELEBRATION ‚îÄ‚îÄ */
    #celebration { display: none; position: fixed; inset: 0; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background-size: 400% 400%; }
    #celebration.show { display: flex; }
    #celebration.tier-100 { background: linear-gradient(135deg, #ffd700, #ff4e50, #ffd700, #fc913a); animation: bgFast 0.7s ease infinite; }
    #celebration.tier-90  { background: linear-gradient(135deg, #8b5cf6, #a78bfa, #6d28d9, #7c3aed); animation: bgShift 2s ease infinite; }
    #celebration.tier-80  { background: linear-gradient(135deg, #3b82f6, #10b981, #2563eb, #059669); animation: bgShift 2.5s ease infinite; }
    #celebration.tier-low { background: linear-gradient(135deg, #f97316, #fb923c, #ea580c, #f59e0b); animation: bgShift 3s ease infinite; }
    @keyframes bgFast  { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @keyframes bgShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .cele-emoji-wrap { margin-bottom: 4px; }
    .cele-main-emoji { font-size: 90px; display: block; animation: emojiSpin 1s linear infinite; }
    @keyframes emojiSpin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

    /* ‚îÄ‚îÄ 100Ï†ê Ï†ÑÏö© ‚îÄ‚îÄ */
    .cele-100-wrap { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
    .cele-main-big { font-size: 110px; z-index: 2; position: relative;
      animation: wildSpin100 0.9s ease-in-out infinite; }
    @keyframes wildSpin100 {
      0%   { transform: rotate(0deg)   scale(1.0); }
      12%  { transform: rotate(72deg)  scale(2.1); }
      25%  { transform: rotate(144deg) scale(0.45); }
      37%  { transform: rotate(216deg) scale(2.3); }
      50%  { transform: rotate(360deg) scale(0.55); }
      62%  { transform: rotate(432deg) scale(1.9); }
      75%  { transform: rotate(504deg) scale(0.4); }
      87%  { transform: rotate(576deg) scale(2.2); }
      100% { transform: rotate(720deg) scale(1.0); }
    }
    .cele-crowd { position: absolute; inset: 0; }
    .crowd-thumb { position: absolute; font-size: 30px;
      animation: crowdCheer 0.38s ease-in-out infinite alternate; }
    @keyframes crowdCheer {
      from { transform: scale(0.7) rotate(-20deg); opacity: 0.75; }
      to   { transform: scale(1.5) rotate(20deg);  opacity: 1.0;  }
    }

    .cele-msg { font-size: 40px; font-weight: 900; color: #fff; text-align: center; padding: 0 20px; text-shadow: 0 4px 24px rgba(0,0,0,0.4); margin: 14px 0 8px; }
    .tier-100 .cele-msg { font-size: 46px; animation: heartbeat 0.45s ease-in-out infinite alternate; }
    .tier-90  .cele-msg { animation: pulse 0.55s ease-in-out infinite alternate; }
    .tier-80  .cele-msg { animation: pulse 0.75s ease-in-out infinite alternate; }
    .tier-low .cele-msg { animation: pulse 1.1s ease-in-out infinite alternate; }
    @keyframes heartbeat { 0%{transform:scale(1)} 60%{transform:scale(1.18)} 100%{transform:scale(1.06)} }
    @keyframes pulse     { from{transform:scale(1)} to{transform:scale(1.09)} }

    .cele-sub { font-size: 19px; color: rgba(255,255,255,0.95); text-align: center; padding: 0 24px; line-height: 1.5; }
    .cele-tap { position: absolute; bottom: 28px; font-size: 15px; color: rgba(255,255,255,0.65); }
    .fly-emoji { position: absolute; font-size: 36px; pointer-events: none; animation: flyUp linear forwards; }
    @keyframes flyUp { 0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1} 100%{transform:translateY(-110vh) rotate(720deg) scale(0.5);opacity:0} }
    .flash-overlay { position: fixed; inset: 0; background: #fff; pointer-events: none; z-index: 10000; animation: screenFlash 0.7s ease forwards; }
    @keyframes screenFlash { 0%,100%{opacity:0} 15%,45%{opacity:0.9} 30%{opacity:0.4} }
  </style>
</head>
<body>

<!-- QUIZ -->
<div id="screen-quiz" class="screen active">
  <div class="page">
    <div class="screen-header">
      <button class="back-btn" onclick="goHome()">‚Üê</button>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="quiz-pf"></div></div>
      </div>
      <div class="progress-text" id="quiz-count"></div>
    </div>
    <div class="quiz-card">
      <div class="qc-header">
        <div>
          <div class="qc-word" id="qc-word"></div>
          <div class="qc-korean" id="qc-korean"></div>
        </div>
        <div class="qc-pos" id="qc-pos"></div>
      </div>
      <div class="qc-sentence" id="qc-sentence"></div>
      <input class="quiz-input" id="quiz-input" type="text" placeholder="ÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div class="feedback" id="feedback"></div>
      <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">ÌôïÏù∏</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div class="page">
    <div class="score-ring">
      <div class="sr-num"   id="sr-num"></div>
      <div class="sr-total" id="sr-total"></div>
    </div>
    <div class="result-title" id="result-title"></div>
    <div class="result-sub"   id="result-sub"></div>
    <div class="wrong-section" id="wrong-section"></div>
    <div class="result-actions">
      <button class="result-btn"         onclick="retryQuiz()">üîÑ Îã§Ïãú ÌíÄÍ∏∞</button>
      <button class="result-btn primary" onclick="goHome()">üè† Ï≤òÏùåÏúºÎ°ú</button>
    </div>
    <div class="done-action">
      <button class="result-btn done-btn" id="btn-done" onclick="toggleDone()">Ïù¥ Îã®Ïõê ÏôÑÎ£å ÌëúÏãú</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- CELEBRATION -->
<div id="celebration" onclick="hideCelebration()">
  <div class="cele-emoji-wrap" id="cele-emoji-wrap"></div>
  <div class="cele-msg" id="cele-msg"></div>
  <div class="cele-sub" id="cele-sub"></div>
  <div class="cele-tap">üëÜ ÌÉ≠Ìï¥ÏÑú Îã´Í∏∞</div>
</div>

<script>
const params   = new URLSearchParams(location.search);
const courseId = params.get('c');
const typeId   = params.get('t');
const unitId   = params.get('u');

let words        = [];
let quizWords    = [];
let quizIdx      = 0;
let quizScore    = 0;
let quizAnswered = false;
let wrongList    = [];

function starKey() { return `star_${courseId}_${typeId}_${unitId}`; }
function saveStarWords(wrongEnglish) {
  if (!wrongEnglish.length) return;
  try {
    const existing = JSON.parse(localStorage.getItem(starKey()) || '[]');
    const merged   = [...new Set([...existing, ...wrongEnglish])];
    localStorage.setItem(starKey(), JSON.stringify(merged));
  } catch {}
}

(async () => {
  if (!courseId || !typeId || !unitId) { location.href = 'index.html'; return; }
  try {
    const r = await fetch(`data/${courseId}/${typeId}/${unitId}.json`);
    const data = await r.json();
    words = data.words;
    startQuiz();
  } catch(e) {
    showToast('‚ö†Ô∏è ÌååÏùº Î°úÎî© Ïã§Ìå®');
  }
})();

function startQuiz() {
  quizIdx = 0; quizScore = 0; quizAnswered = false; wrongList = [];
  quizWords = shuffle([...words]);
  showScreen('screen-quiz');
  renderQuizCard();
}

function renderQuizCard() {
  const w = quizWords[quizIdx];
  quizAnswered = false;
  document.getElementById('qc-word').textContent   = w.english;
  document.getElementById('qc-korean').textContent = w.korean;
  document.getElementById('qc-pos').textContent    = w.pos || '';
  document.getElementById('qc-pos').style.display  = w.pos ? '' : 'none';
  document.getElementById('qc-sentence').innerHTML = w.sentence.replace('___', '<span class="blank">___</span>');
  const inp = document.getElementById('quiz-input');
  inp.value = ''; inp.className = 'quiz-input'; inp.disabled = false; inp.focus();
  const fb = document.getElementById('feedback');
  fb.className = 'feedback'; fb.textContent = '';
  document.getElementById('submit-btn').textContent = 'ÌôïÏù∏';
  const pct = (quizIdx / quizWords.length) * 100;
  document.getElementById('quiz-pf').style.width = pct + '%';
  document.getElementById('quiz-count').textContent = `${quizIdx + 1} / ${quizWords.length}`;
}

function submitAnswer() {
  if (quizAnswered) {
    quizIdx++;
    if (quizIdx >= quizWords.length) showResult();
    else renderQuizCard();
    return;
  }
  const w = quizWords[quizIdx];
  const inp = document.getElementById('quiz-input');
  const user = inp.value.trim();
  const correct = w.answer;
  const ok = user.toLowerCase() === correct.toLowerCase();
  quizAnswered = true; inp.disabled = true;
  const fb = document.getElementById('feedback');
  if (ok) {
    quizScore++;
    inp.classList.add('correct');
    fb.className = 'feedback correct'; fb.textContent = '‚úÖ Ï†ïÎãµ!';
  } else {
    inp.classList.add('wrong');
    fb.className = 'feedback wrong'; fb.textContent = `‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§.  Ï†ïÎãµ: "${correct}"`;
    wrongList.push({ w, user });
    saveStarWords([w.english]); // ÌãÄÎ¶¨Îäî Ï¶âÏãú Ï†ÄÏû•
  }
  const isLast = quizIdx >= quizWords.length - 1;
  document.getElementById('submit-btn').textContent = isLast ? 'Í≤∞Í≥º Î≥¥Í∏∞ üìä' : 'Îã§Ïùå Î¨∏Ï†ú ‚ñ∂';
}

document.getElementById('quiz-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitAnswer();
});

function showResult() {
  showScreen('screen-result');
  loadDoneState();
  const total = quizWords.length;
  const pct   = Math.round(quizScore / total * 100);
  const isPerfect = wrongList.length === 0;
  document.getElementById('sr-num').textContent   = quizScore;
  document.getElementById('sr-total').textContent = `/ ${total}`;
  let title, sub;
  if (isPerfect)      { title = 'üëçüëç ÏôÑÎ≤ΩÌï¥Ïöî!!';   sub = 'Ìïú Î≤àÎèÑ Ïïà ÌãÄÎ¶∞ 100Ï†ê!! ÏåçÎî∞Î¥â!'; }
  else if (pct >= 90) { title = 'üåü ÎåÄÎã®Ìï¥Ïöî!';      sub = `${pct}Ï†ê ‚Äî Ï°∞Í∏àÎßå Îçî ÌïòÎ©¥ ÏôÑÎ≤Ω!`; }
  else if (pct >= 80) { title = 'üëè ÏûòÌñàÏñ¥Ïöî!';      sub = `${pct}Ï†ê ‚Äî ÌãÄÎ¶∞ Îã®Ïñ¥ Î≥µÏäµÌï¥Î¥êÏöî!`; }
  else if (pct >= 60) { title = 'üí™ ÎÖ∏Î†•Ìï¥Ïöî!';      sub = `${pct}Ï†ê ‚Äî Ìè¨Í∏∞ÌïòÏßÄ Îßà! Ìï† Ïàò ÏûàÏñ¥!`; }
  else                { title = 'üìñ Îã§Ïãú Í≥µÎ∂ÄÌï¥Ïöî!';  sub = `${pct}Ï†ê ‚Äî ÌîåÎûòÏãúÏπ¥ÎìúÎ∂ÄÌÑ∞ Îã§Ïãú! ÌååÏù¥ÌåÖ!`; }
  document.getElementById('result-title').textContent = title;
  document.getElementById('result-sub').textContent   = sub;
  const sec = document.getElementById('wrong-section');
  sec.innerHTML = '';
  if (wrongList.length) {
    sec.innerHTML = '<div class="section-label" style="margin-top:0">ÌãÄÎ¶∞ Îã®Ïñ¥</div>';
    wrongList.forEach(({ w, user }) => {
      const d = document.createElement('div');
      d.className = 'wrong-item';
      d.innerHTML = `<div class="wi-word">${w.english} ‚Äî ${w.korean}</div><div class="wi-ans">ÎÇ¥ Îãµ: "${user}"„ÄÄ‚Üí„ÄÄÏ†ïÎãµ: "${w.answer}"</div>`;
      sec.appendChild(d);
    });
  }
  // ÌãÄÎ¶∞ Îã®Ïñ¥ ‚òÖ‚òÖ‚òÖ Ï†ÄÏû• (study.htmlÏóêÏÑú ÌëúÏãú)
  saveStarWords(wrongList.map(item => item.w.english));
  setTimeout(() => triggerCelebration(pct, isPerfect), 400);
}

function retryQuiz() { hideCelebration(); startQuiz(); }
function goHome() { hideCelebration(); location.href = 'index.html'; }

// ‚îÄ‚îÄ CELEBRATION ‚îÄ‚îÄ
const CELE_TIERS = {
  100: {
    cls: 'tier-100',
    emoji: 'thumbs',
    msg: 'üëçüëç ÏåçÎî∞Î¥â!! ÏôÑÏ†Ñ ÎøÖ~ üí´',
    sub: 'Ìïú Î≤àÎèÑ Ïïà ÌãÄÎ¶∞ ÏôÑÎ≤ΩÌïú 100Ï†ê!! ÏµúÍ∞ïÏù¥Ïïº!! üèÜ',
    particles: ['üëç','üíØ','üåü','‚ú®','üéâ','üèÜ','üí´','‚≠ê','üéä','üî•','üòç','üéØ'],
    count: 65, interval: 75,
  },
  90: {
    cls: 'tier-90',
    emoji: 'üèÜ',
    msg: 'üåü ÎåÄÎã®Ìï¥!! Í±∞Ïùò ÏôÑÎ≤ΩÌï¥!',
    sub: '90Ï†êÎåÄ! Ï°∞Í∏àÎßå Îçî ÌïòÎ©¥ 100Ï†êÏù¥Ïïº! ‚≠ê‚≠ê‚≠ê',
    particles: ['üèÜ','‚≠ê','‚ú®','üåü','üéâ','üëç','üòÑ','üéä'],
    count: 38, interval: 110,
  },
  80: {
    cls: 'tier-80',
    emoji: 'üëè',
    msg: 'üòä ÏûòÌñàÏñ¥! Ï¢ãÏùÄ Ï†êÏàòÏïº!',
    sub: '80Ï†êÎåÄ! ÌãÄÎ¶∞ Îã®Ïñ¥ Î≥µÏäµÌïòÎ©¥ ÏôÑÎ≤ΩÌï¥! üí™',
    particles: ['üëè','üòä','üí™','‚≠ê','üéà','‚ú®'],
    count: 22, interval: 160,
  },
  low: {
    cls: 'tier-low',
    emoji: 'üí™',
    msg: 'üí™ Ìè¨Í∏∞ÌïòÏßÄ Îßà! Ìï† Ïàò ÏûàÏñ¥!!',
    sub: 'Í≥ÑÏÜç Ïó∞ÏäµÌïòÎ©¥ Í∏àÎ∞© ÎäòÏñ¥! ÌååÏù¥ÌåÖ!! üî•',
    particles: ['üí™','üî•','üò§','‚≠ê','‚ú®','üåü'],
    count: 16, interval: 200,
  },
};

function getTier(pct, isPerfect) {
  if (isPerfect && pct === 100) return 100;
  if (pct >= 90) return 90;
  if (pct >= 80) return 80;
  return 'low';
}

function triggerCelebration(pct, isPerfect) {
  const key  = getTier(pct, isPerfect);
  const data = CELE_TIERS[key];
  const cel  = document.getElementById('celebration');

  // Í∏∞Ï°¥ ÌååÌã∞ÌÅ¥ Ï†úÍ±∞
  cel.querySelectorAll('.fly-emoji').forEach(e => e.remove());
  cel.className = 'show ' + data.cls;

  // Ïù¥Î™®ÏßÄ
  const wrap = document.getElementById('cele-emoji-wrap');
  if (data.emoji === 'thumbs') {
    wrap.innerHTML = '<div class="cele-100-wrap"><div class="cele-crowd"></div><div class="cele-main-big">üëç</div></div>';
    const crowd = wrap.querySelector('.cele-crowd');
    for (let i = 0; i < 10; i++) {
      const angle = (i / 10) * Math.PI * 2;
      const r = 105;
      const x = 140 + r * Math.cos(angle) - 15;
      const y = 140 + r * Math.sin(angle) - 15;
      const sp = document.createElement('span');
      sp.className = 'crowd-thumb';
      sp.textContent = 'üëç';
      sp.style.left = x + 'px';
      sp.style.top  = y + 'px';
      sp.style.animationDelay = (i * 0.038) + 's';
      crowd.appendChild(sp);
    }
  } else {
    wrap.innerHTML = `<span class="cele-main-emoji">${data.emoji}</span>`;
  }
  document.getElementById('cele-msg').textContent = data.msg;
  document.getElementById('cele-sub').textContent = data.sub;

  // 100Ï†ê ÌôîÎ©¥ ÌîåÎûòÏãú
  if (key === 100) {
    const fl = document.createElement('div');
    fl.className = 'flash-overlay';
    document.body.appendChild(fl);
    setTimeout(() => fl.remove(), 800);
  }

  // ÌååÌã∞ÌÅ¥
  let cnt = 0;
  const iv = setInterval(() => {
    if (cnt++ >= data.count) { clearInterval(iv); return; }
    const el = document.createElement('span');
    el.className = 'fly-emoji';
    el.textContent = data.particles[Math.floor(Math.random() * data.particles.length)];
    el.style.left = (Math.random() * 95) + 'vw';
    el.style.bottom = '-50px';
    el.style.animationDuration = (1.2 + Math.random() * 1.8) + 's';
    cel.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  }, data.interval);

  // 5Ï¥à ÌõÑ ÏûêÎèô Îã´Í∏∞
  setTimeout(hideCelebration, 5000);
}

function hideCelebration() {
  const cel = document.getElementById('celebration');
  cel.classList.remove('show');
  cel.querySelectorAll('.fly-emoji').forEach(e => e.remove());
}

// ‚îÄ‚îÄ DONE ‚îÄ‚îÄ
let isDoneState = false;
function doneKey() { return `${courseId}_${typeId}_${unitId}`; }

async function loadDoneState() {
  try {
    const r = await fetch('/api/done');
    const data = await r.json();
    isDoneState = data.done.includes(doneKey());
  } catch { isDoneState = false; }
  updateDoneBtn();
}

function updateDoneBtn() {
  const btn = document.getElementById('btn-done');
  if (!btn) return;
  btn.textContent = isDoneState ? '‚úÖ ÏôÑÎ£åÎê®' : 'Ïù¥ Îã®Ïõê ÏôÑÎ£å ÌëúÏãú';
  btn.classList.toggle('on', isDoneState);
}

async function toggleDone() {
  isDoneState = !isDoneState;
  try {
    await fetch('/api/done', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: doneKey(), done: isDoneState })
    });
  } catch { isDoneState = !isDoneState; }
  updateDoneBtn();
  showToast(isDoneState ? '‚úÖ ÏôÑÎ£å! Î©îÏù∏ÏóêÏÑú Îã§Ïùå Îã®ÏõêÏúºÎ°ú ÎÑòÏñ¥Í∞ÄÏÑ∏Ïöî' : 'ÏôÑÎ£å Ï∑®ÏÜåÌñàÏäµÎãàÎã§');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
