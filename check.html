<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì‚¬ì§„ ì±„ì  â€” ì°¬í¬ ì˜ì–´ ë‹¨ì–´ì¥</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
    :root {
      --primary: #5b4fcf; --primary-light: #7c71e0; --primary-bg: #eef2ff;
      --green: #10b981; --green-bg: #ecfdf5; --red: #ef4444; --red-bg: #fef2f2;
      --yellow: #f59e0b; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
      --muted: #64748b; --border: #e2e8f0; --radius: 14px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .page { padding: 16px; max-width: 760px; margin: 0 auto; padding-bottom: 48px; }

    /* HEADER */
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .back-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 4px 8px; border-radius: 8px; }
    .header-title { font-size: 20px; font-weight: 800; color: var(--primary); }
    .unit-badge { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* MODE TABS */
    .mode-tabs { display: flex; gap: 0; margin-bottom: 20px; border-radius: var(--radius); overflow: hidden; border: 2px solid var(--border); }
    .mode-tab { flex: 1; padding: 14px 8px; text-align: center; font-size: 14px; font-weight: 700; cursor: pointer; background: var(--card); color: var(--muted); border: none; transition: all 0.15s; }
    .mode-tab.on { background: var(--primary); color: #fff; }

    /* ANSWER CARD */
    .ans-card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
    .ans-item { display: grid; grid-template-columns: 28px 1fr 80px; gap: 10px; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .ans-item:last-child { border-bottom: none; }
    .ans-item.marked-ok   { background: var(--green-bg); }
    .ans-item.marked-fail { background: var(--red-bg); }
    .ai-no   { font-size: 13px; color: var(--muted); font-weight: 700; }
    .ai-body { }
    .ai-answer { font-size: 17px; font-weight: 800; color: var(--primary); }
    .ai-sent   { font-size: 12px; color: var(--muted); margin-top: 2px; line-height: 1.5; }
    .ai-btns { display: flex; gap: 6px; justify-content: flex-end; }
    .ai-btn { width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--border); background: var(--card); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .ai-btn.ok   { border-color: var(--green); background: var(--green-bg); }
    .ai-btn.fail { border-color: var(--red);   background: var(--red-bg); }
    .ans-summary { background: var(--card); border-radius: var(--radius); border: 2px solid var(--primary); padding: 16px; text-align: center; margin-bottom: 16px; font-size: 18px; font-weight: 800; color: var(--primary); display: none; }

    /* API KEY SECTION */
    .api-section { background: #fff8e1; border: 2px dashed #f59e0b; border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
    .api-title { font-size: 15px; font-weight: 700; color: #92400e; margin-bottom: 10px; }
    .api-desc { font-size: 13px; color: #78350f; margin-bottom: 12px; line-height: 1.6; }
    .api-row { display: flex; gap: 8px; }
    .api-input { flex: 1; padding: 10px 14px; border: 2px solid #f59e0b; border-radius: 10px; font-size: 14px; font-family: monospace; outline: none; }
    .api-input:focus { border-color: #d97706; }
    .api-save-btn { padding: 10px 18px; background: #f59e0b; color: #fff; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; white-space: nowrap; }
    .api-ok { font-size: 13px; color: var(--green); font-weight: 600; margin-top: 8px; display: none; }

    /* PHOTO SECTION */
    .photo-section { background: var(--card); border: 2px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
    .photo-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .photo-desc { font-size: 13px; color: var(--muted); margin-bottom: 16px; line-height: 1.6; }
    .photo-btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .photo-btn { flex: 1; min-width: 140px; padding: 16px 10px; border: 2px solid var(--primary); border-radius: var(--radius); background: var(--primary-bg); color: var(--primary); font-size: 15px; font-weight: 700; cursor: pointer; text-align: center; }
    .photo-btn:active { background: var(--primary); color: #fff; }
    input[type="file"] { display: none; }
    .preview-wrap { margin-top: 16px; display: none; }
    .preview-img { width: 100%; max-height: 320px; object-fit: contain; border-radius: 10px; border: 2px solid var(--border); }
    .grade-btn { width: 100%; margin-top: 14px; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius); font-size: 17px; font-weight: 700; cursor: pointer; display: none; }
    .grade-btn:disabled { background: #cbd5e1; cursor: not-allowed; }

    /* LOADING */
    .loading { text-align: center; padding: 40px 20px; display: none; }
    .loading-spinner { font-size: 48px; animation: spin 1s linear infinite; display: block; margin-bottom: 12px; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    .loading-msg { font-size: 16px; color: var(--muted); font-weight: 600; }

    /* RESULTS */
    .results { display: none; }
    .result-header { background: linear-gradient(135deg, #5b4fcf, #7c71e0); color: #fff; border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 16px; }
    .rh-score { font-size: 42px; font-weight: 900; }
    .rh-detail { font-size: 15px; opacity: 0.9; margin-top: 4px; }
    .result-list { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
    .result-item { display: grid; grid-template-columns: 28px 1fr auto; gap: 10px; align-items: start; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .result-item:last-child { border-bottom: none; }
    .result-item.correct { background: var(--green-bg); }
    .result-item.wrong   { background: var(--red-bg); }
    .ri-no     { font-size: 12px; color: var(--muted); padding-top: 2px; }
    .ri-body   { font-size: 14px; line-height: 1.6; }
    .ri-word   { font-weight: 700; font-size: 15px; }
    .ri-user   { font-size: 13px; }
    .ri-user .user-ans { color: var(--red); font-weight: 600; }
    .ri-user .ok-ans   { color: var(--green); font-weight: 600; }
    .ri-icon   { font-size: 20px; }

    .star-btn { width: 100%; padding: 14px; background: #f59e0b; color: #fff; border: none; border-radius: var(--radius); font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
    .retry-btn { width: 100%; padding: 14px; background: var(--card); border: 2px solid var(--border); border-radius: var(--radius); font-size: 15px; font-weight: 600; cursor: pointer; }

    /* ERROR */
    .error-box { background: var(--red-bg); border: 2px solid var(--red); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; font-size: 14px; color: var(--red); line-height: 1.6; display: none; }

    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
<div class="page">
  <div class="header">
    <button class="back-btn" onclick="goBack()">â†</button>
    <div>
      <div class="header-title">ğŸ“¸ ì‚¬ì§„ ì±„ì </div>
      <div class="unit-badge" id="unit-badge"></div>
    </div>
  </div>

  <!-- ëª¨ë“œ íƒ­ -->
  <div class="mode-tabs">
    <button class="mode-tab on" id="tab-manual" onclick="switchMode('manual')">ğŸ“‹ ì •ë‹µ ì¹´ë“œ (ì¦‰ì‹œ)</button>
    <button class="mode-tab" id="tab-ai" onclick="switchMode('ai')">ğŸ“¸ AI ì‚¬ì§„ ì±„ì </button>
  </div>

  <!-- ì •ë‹µ ì¹´ë“œ ëª¨ë“œ -->
  <div id="manual-mode">
    <div style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.6">
      ì‹œí—˜ì§€ ë³´ë©´ì„œ âœ… / âŒ ë¥¼ ì§ì ‘ íƒ­í•´ì„œ ì±„ì í•˜ì„¸ìš”.
    </div>
    <div class="ans-card" id="ans-card"></div>
    <div class="ans-summary" id="ans-summary"></div>
    <button class="star-btn" id="manual-star-btn" onclick="saveManualWrongAsStars()" style="display:none">â­ í‹€ë¦° ë‹¨ì–´ ë³„í‘œë¡œ ì €ì¥</button>
  </div>

  <!-- AI ì±„ì  ëª¨ë“œ -->
  <div id="ai-mode" style="display:none">

  <!-- API í‚¤ ì„¤ì • -->
  <div class="api-section" id="api-section">
    <div class="api-title">ğŸ”‘ Groq API í‚¤ ì„¤ì • (ìµœì´ˆ 1íšŒ Â· ì™„ì „ ë¬´ë£Œ)</div>
    <div class="api-desc">
      ë¬´ë£Œ í‚¤ ë°œê¸‰: <strong>console.groq.com</strong> â†’ íšŒì›ê°€ì… â†’ API Keys â†’ Create API Key<br>
      í•˜ë£¨ 14,400ë²ˆ ë¬´ë£Œ Â· í‚¤ëŠ” ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
    </div>
    <div class="api-row">
      <input class="api-input" id="api-key-input" type="password" placeholder="gsk_...">
      <button class="api-save-btn" onclick="saveApiKey()">ì €ì¥</button>
    </div>
    <div class="api-ok" id="api-ok">âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  </div>

  <!-- ì‚¬ì§„ ì´¬ì˜ -->
  <div class="photo-section" id="photo-section">
    <div class="photo-title">ğŸ“„ ì‹œí—˜ì§€ ì‚¬ì§„ ì°ê¸°</div>
    <div class="photo-desc">
      ì°¬í¬ê°€ ë‹µì„ ì“´ <strong>1í˜ì´ì§€(ë¬¸ì¥ ë¹ˆì¹¸)</strong> ì‹œí—˜ì§€ë¥¼ ì°ì–´ì£¼ì„¸ìš”.<br>
      ë°ì€ ê³³ì—ì„œ ë°˜ë“¯í•˜ê²Œ ì°ì„ìˆ˜ë¡ ì •í™•í•©ë‹ˆë‹¤.
    </div>
    <div class="photo-btns">
      <button class="photo-btn" onclick="document.getElementById('camera-input').click()">ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°</button>
      <button class="photo-btn" onclick="document.getElementById('file-input').click()">ğŸ–¼ ì‚¬ì§„ ì„ íƒ</button>
    </div>
    <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="onPhotoSelected(this)">
    <input type="file" id="file-input"   accept="image/*" onchange="onPhotoSelected(this)">
    <div class="preview-wrap" id="preview-wrap">
      <img class="preview-img" id="preview-img" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
      <button class="grade-btn" id="grade-btn" onclick="startGrading()">ğŸ¤– AI ì±„ì  ì‹œì‘</button>
    </div>
  </div>

  <!-- ì˜¤ë¥˜ -->
  <div class="error-box" id="error-box"></div>

  <!-- ë¡œë”© -->
  <div class="loading" id="loading">
    <span class="loading-spinner">ğŸ¤–</span>
    <div class="loading-msg">AIê°€ ì‹œí—˜ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</div>
  </div>

  <!-- ê²°ê³¼ -->
  <div class="results" id="results">
    <div class="result-header">
      <div class="rh-score" id="rh-score"></div>
      <div class="rh-detail" id="rh-detail"></div>
    </div>
    <div class="result-list" id="result-list"></div>
    <button class="star-btn" id="star-btn" onclick="saveWrongAsStars()" style="display:none">â­ í‹€ë¦° ë‹¨ì–´ ë³„í‘œë¡œ ì €ì¥</button>
    <button class="retry-btn" onclick="resetToPhoto()">ğŸ”„ ë‹¤ì‹œ ì°ê¸°</button>
  </div>

  </div><!-- /ai-mode -->
</div><!-- /page -->

<div class="toast" id="toast"></div>

<script>
const params   = new URLSearchParams(location.search);
const courseId = params.get('c');
const typeId   = params.get('t');
const unitId   = params.get('u');

let words        = [];
let imageBase64  = '';
let gradeResult  = [];
let manualResult = []; // null | true | false per word

// â”€â”€ INIT â”€â”€
(async () => {
  if (!courseId || !typeId || !unitId) { location.href = 'index.html'; return; }
  try {
    const r    = await fetch(`data/${courseId}/${typeId}/${unitId}.json`);
    const data = await r.json();
    words = data.words;
    document.getElementById('unit-badge').textContent =
      `${courseId} Â· ${typeId} Â· ${unitId} â€” ${words.length}ê°œ ë‹¨ì–´`;
    renderAnswerCard();
  } catch { showError('ë‹¨ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); }

  // API í‚¤ ë¡œë“œ
  const saved = localStorage.getItem('groq_api_key');
  if (saved) {
    document.getElementById('api-key-input').value = saved;
    document.getElementById('api-ok').style.display = 'block';
    document.getElementById('api-section').style.borderColor = '#10b981';
  }
})();

// â”€â”€ MODE SWITCH â”€â”€
function switchMode(mode) {
  document.getElementById('manual-mode').style.display = mode === 'manual' ? 'block' : 'none';
  document.getElementById('ai-mode').style.display     = mode === 'ai'     ? 'block' : 'none';
  document.getElementById('tab-manual').classList.toggle('on', mode === 'manual');
  document.getElementById('tab-ai').classList.toggle('on', mode === 'ai');
}

// â”€â”€ ì •ë‹µ ì¹´ë“œ (ìˆ˜ë™ ì±„ì ) â”€â”€
function renderAnswerCard() {
  manualResult = new Array(words.length).fill(null);
  const card = document.getElementById('ans-card');
  card.innerHTML = '';
  words.forEach((w, i) => {
    const item = document.createElement('div');
    item.className = 'ans-item';
    item.id = `ans-item-${i}`;
    const sentPreview = w.sentence.replace('___', `<strong style="color:var(--primary)">${w.answer}</strong>`);
    item.innerHTML = `
      <div class="ai-no">${i + 1}</div>
      <div class="ai-body">
        <div class="ai-answer">${w.answer}</div>
        <div class="ai-sent">${sentPreview}</div>
      </div>
      <div class="ai-btns">
        <button class="ai-btn" id="btn-ok-${i}"   onclick="markManual(${i}, true)">âœ…</button>
        <button class="ai-btn" id="btn-fail-${i}" onclick="markManual(${i}, false)">âŒ</button>
      </div>`;
    card.appendChild(item);
  });
}

function markManual(i, isOk) {
  manualResult[i] = isOk;
  const item = document.getElementById(`ans-item-${i}`);
  item.classList.toggle('marked-ok',   isOk);
  item.classList.toggle('marked-fail', !isOk);
  document.getElementById(`btn-ok-${i}`).classList.toggle('ok',     isOk);
  document.getElementById(`btn-fail-${i}`).classList.toggle('fail', !isOk);

  // ì „ë¶€ ì²´í¬í–ˆìœ¼ë©´ ìš”ì•½ í‘œì‹œ
  if (manualResult.every(v => v !== null)) {
    const correct = manualResult.filter(v => v).length;
    const total   = words.length;
    const pct     = Math.round(correct / total * 100);
    const summary = document.getElementById('ans-summary');
    summary.textContent = `${pct}ì  â€” ${total}ë¬¸ì œ ì¤‘ ${correct}ê°œ ì •ë‹µ ğŸ‰`;
    summary.style.display = 'block';
    const wrongCount = total - correct;
    document.getElementById('manual-star-btn').style.display = wrongCount > 0 ? 'block' : 'none';
  }
}

function saveManualWrongAsStars() {
  const wrongEnglish = words.filter((_, i) => manualResult[i] === false).map(w => w.english);
  if (!wrongEnglish.length) return;
  const key = `star_${courseId}_${typeId}_${unitId}`;
  try {
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    const merged   = [...new Set([...existing, ...wrongEnglish])];
    localStorage.setItem(key, JSON.stringify(merged));
    showToast(`â­ ${wrongEnglish.length}ê°œ ë‹¨ì–´ ë³„í‘œ ì €ì¥ ì™„ë£Œ!`);
    document.getElementById('manual-star-btn').disabled = true;
    document.getElementById('manual-star-btn').textContent = 'â­ ì €ì¥ ì™„ë£Œ!';
  } catch { showToast('ì €ì¥ ì‹¤íŒ¨'); }
}

// â”€â”€ API KEY â”€â”€
function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) { showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  localStorage.setItem('groq_api_key', key);
  document.getElementById('api-ok').style.display = 'block';
  document.getElementById('api-section').style.borderColor = '#10b981';
  showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€ PHOTO â”€â”€
function onPhotoSelected(input) {
  const file = input.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  document.getElementById('preview-img').src = url;
  document.getElementById('preview-wrap').style.display = 'block';
  document.getElementById('grade-btn').style.display = 'block';
  // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í›„ base64 ì €ì¥
  resizeImage(file).then(b64 => { imageBase64 = b64; });
  // ê²°ê³¼ ì´ˆê¸°í™”
  document.getElementById('results').style.display = 'none';
  document.getElementById('error-box').style.display = 'none';
}

function resizeImage(file, maxWidth = 1600) {
  return new Promise(resolve => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      const scale = Math.min(1, maxWidth / img.width);
      const canvas = document.createElement('canvas');
      canvas.width  = img.width  * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
    };
    img.src = url;
  });
}

// â”€â”€ GRADING â”€â”€
async function startGrading() {
  const apiKey = localStorage.getItem('groq_api_key');
  if (!apiKey) { showToast('ë¨¼ì € API í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”'); return; }
  if (!imageBase64) { showToast('ì‚¬ì§„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }

  document.getElementById('photo-section').style.display = 'none';
  document.getElementById('error-box').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  document.getElementById('results').style.display = 'none';

  const answerList = words.map((w, i) => `${i + 1}ë²ˆ ì •ë‹µ: "${w.answer}"`).join('\n');

  const prompt = `ì´ ì´ë¯¸ì§€ëŠ” ì˜ì–´ ì‹œí—˜ì§€ì…ë‹ˆë‹¤. í•™ìƒì´ ë¹ˆì¹¸ì— ì†ê¸€ì”¨ë¡œ ë‹µì„ ì¼ìŠµë‹ˆë‹¤.

ê° ë²ˆí˜¸ì˜ ë¹ˆì¹¸ì— í•™ìƒì´ ì“´ ì†ê¸€ì”¨ë¥¼ ì½ì–´ì£¼ì„¸ìš”.

ì°¸ê³ ìš© ì •ë‹µ ëª©ë¡ (ì±„ì ì— ì‚¬ìš©í•˜ì§€ ë§ê³  ì†ê¸€ì”¨ ì¸ì‹ì—ë§Œ ì°¸ê³ í•˜ì„¸ìš”):
${answerList}

í•™ìƒì´ ì‹¤ì œë¡œ ì“´ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì½ì–´ì„œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{"1":"í•™ìƒì´ì“´ë‹µ","2":"í•™ìƒì´ì“´ë‹µ",...}

ë¹ˆì¹¸ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ ë¬¸ìì—´("")ë¡œ í‘œì‹œí•˜ì„¸ìš”.
JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
        max_tokens: 1024,
        temperature: 0.1,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image_url',
              image_url: { url: `data:image/jpeg;base64,${imageBase64}` }
            },
            { type: 'text', text: prompt }
          ]
        }]
      })
    });

    const data = await res.json();

    if (!res.ok) {
      const msg = data?.error?.message || '';
      if (res.status === 401) throw new Error('API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nâ€¢ gsk_ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ì¸ì§€ í™•ì¸í•˜ì„¸ìš”\nâ€¢ console.groq.com ì—ì„œ ìƒˆ í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”');
      if (res.status === 429) throw new Error('ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.\n(í•˜ë£¨ 14,400ë²ˆ ë¬´ë£Œ í•œë„)');
      throw new Error(`API ì˜¤ë¥˜: ${msg || res.status}`);
    }

    const rawText = data.choices?.[0]?.message?.content || '';
    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');

    const extracted = JSON.parse(jsonMatch[0]);
    showResults(extracted);

  } catch (e) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('photo-section').style.display = 'block';
    showError(`ì±„ì  ì˜¤ë¥˜: ${e.message}`);
  }
}

// â”€â”€ RESULTS â”€â”€
function normEn(s) { return (s || '').trim().replace(/\s+/g, ' '); }

function showResults(extracted) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('results').style.display = 'block';

  gradeResult = [];
  let correct = 0;
  const list = document.getElementById('result-list');
  list.innerHTML = '';

  words.forEach((w, i) => {
    const no      = String(i + 1);
    const userAns = extracted[no] || '';
    const isOk    = normEn(userAns).toLowerCase() === normEn(w.answer).toLowerCase();
    if (isOk) correct++;
    gradeResult.push({ word: w, userAns, correct: isOk });

    const item = document.createElement('div');
    item.className = `result-item ${isOk ? 'correct' : 'wrong'}`;
    item.innerHTML = `
      <div class="ri-no">${no}</div>
      <div class="ri-body">
        <div class="ri-word">${w.english} <span style="font-size:12px;font-weight:400;color:var(--muted)">${w.korean.split(',')[0]}</span></div>
        ${isOk
          ? `<div class="ri-user"><span class="ok-ans">âœ… ${userAns || w.answer}</span></div>`
          : `<div class="ri-user">
               ë‚´ ë‹µ: <span class="user-ans">"${userAns || '(ë¹ˆì¹¸)'}"</span><br>
               ì •ë‹µ: <span class="ok-ans">"${w.answer}"</span>
             </div>`
        }
        <div style="font-size:12px;color:var(--muted);margin-top:2px">${w.sentence.replace('___', `<strong>${w.answer}</strong>`)}</div>
      </div>
      <div class="ri-icon">${isOk ? 'âœ…' : 'âŒ'}</div>`;
    list.appendChild(item);
  });

  const total = words.length;
  const pct   = Math.round(correct / total * 100);
  document.getElementById('rh-score').textContent = `${pct}ì `;
  document.getElementById('rh-detail').textContent = `${total}ë¬¸ì œ ì¤‘ ${correct}ê°œ ì •ë‹µ Â· ${total - correct}ê°œ ì˜¤ë‹µ`;

  const wrongCount = total - correct;
  const starBtn = document.getElementById('star-btn');
  starBtn.style.display = wrongCount > 0 ? 'block' : 'none';
}

function saveWrongAsStars() {
  const wrongEnglish = gradeResult.filter(r => !r.correct).map(r => r.word.english);
  if (!wrongEnglish.length) return;
  const key = `star_${courseId}_${typeId}_${unitId}`;
  try {
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    const merged   = [...new Set([...existing, ...wrongEnglish])];
    localStorage.setItem(key, JSON.stringify(merged));
    showToast(`â­ ${wrongEnglish.length}ê°œ ë‹¨ì–´ ë³„í‘œ ì €ì¥ ì™„ë£Œ!`);
    document.getElementById('star-btn').disabled = true;
    document.getElementById('star-btn').textContent = 'â­ ì €ì¥ ì™„ë£Œ!';
  } catch { showToast('ì €ì¥ ì‹¤íŒ¨'); }
}

function resetToPhoto() {
  document.getElementById('results').style.display = 'none';
  document.getElementById('photo-section').style.display = 'block';
  document.getElementById('preview-wrap').style.display = 'none';
  document.getElementById('grade-btn').style.display = 'none';
  imageBase64 = '';
}

function showError(msg) {
  const el = document.getElementById('error-box');
  el.textContent = msg;
  el.style.display = 'block';
}

function goBack() {
  const p = new URLSearchParams({ c: courseId, t: typeId, u: unitId });
  location.href = 'index.html?' + p;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
<script src="nav.js"></script>
<script>initNav('check');</script>
</body>
</html>